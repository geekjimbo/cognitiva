<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Scatter Plot - Stores</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3-legend/1.1.0/d3-legend.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Poiret+One' rel='stylesheet' type='text/css'>
    <style>
    
      .axis text {
        font-family: 'Poiret One', cursive;
        font-size: 12pt;
      }
      .axis .label {
        font-size: 14pt;
      }

      .axis path, .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      circle:hover {
        stroke: black;
        stroke-width: 1px;
      }
    </style>
  </head>
  <body>
    <script>
    
      var dataArray;
      var outerWidth = 1200;
      var outerHeight = 700;
      var margin = { left: 120, top: 50, right: 10, bottom: 80 };
      var rMin = 0; // "r" stands for radius
      var rMax = 20;
      var xColumn = "date";
      var yColumn = "score";
      var rColumn = "qty_notes";
      var colorColumn = "storeid";

      var xAxisLabelText = "datetime";
      var xAxisLabelOffset = 54;

      var yAxisLabelText = "sentiment score";
      var yAxisLabelOffset = 50;

      var innerWidth  = outerWidth  - margin.left - margin.right;
      var innerHeight = outerHeight - margin.top  - margin.bottom;
      var introLabel = "Cognitiva's Watson esta calculando el An√°lisis de Sentimiento..."
      var toprightLabel = "test text"

      var svg = d3.select("body").append("svg")
        .attr("width", outerWidth)
        .attr("height", outerHeight);

      var introText = svg.append("text").text(introLabel)
        .attr("text-anchor", "middle")
        .attr("x", outerWidth / 2)
        .attr("y", outerHeight / 2);

      var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var toprightText = g.append("text").text(toprightLabel)
        .attr("text-anchor", "end")
        .attr("x", innerWidth)
        .attr("y", 0);

      var xAxisG = g.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + innerHeight + ")")
      var xAxisLabel = xAxisG.append("text")
        .style("text-anchor", "middle")
        .attr("x", innerWidth / 2)
        .attr("y", xAxisLabelOffset)
        .attr("class", "label");

      var yAxisG = g.append("g")
        .attr("class", "y axis");
      var yAxisLabel = yAxisG.append("text")
        .style("text-anchor", "middle")
        .attr("transform", "translate(-" + yAxisLabelOffset + "," + (innerHeight / 2) + ") rotate(-90)")
        .attr("class", "label");

      var colorLegendG = g.append("g")
              .attr("class", "color-legend")
                      .attr("transform", "translate(200,"+ (innerHeight+42)+")");

      //var xScale = d3.scale.linear().range([0, innerWidth]);
      var xScale = d3.time.scale().range([0, innerWidth]);
      var yScale = d3.scale.linear().range([innerHeight, 0]);
      //var rScale = d3.scale.linear().range([rMin, rMax]);
      var rScale = d3.scale.sqrt().range([rMin, rMax]);
      var colorScale = d3.scale.category10();
     // var colorScale = d3.scale.ordinal()
     //   .range(["#0066FF", "#CC0066", "#33CC33"]);

      var xAxis = d3.svg.axis().scale(xScale).orient("bottom")
        .ticks(10)
        //.tickFormat(d3.format("s"))
        .outerTickSize(0);
      var yAxis = d3.svg.axis().scale(yScale).orient("left")
        .ticks(5)
        //.tickFormat(d3.format("s"))
        .outerTickSize(0);

      var colorLegend = d3.legend.color()
        .scale(colorScale)
        .orient('horizontal')
        .shapePadding(35)
        .shapeWidth(25)
        .shapeHeight(25)
        .labelOffset(5);

      function renderCircles(data){
        xScale.domain(d3.extent(data, function (d){ return d[xColumn]; }));
        yScale.domain(d3.extent(data, function (d){ return d[yColumn]; })).nice();
        rScale.domain(d3.extent(data, function (d){ return d[rColumn]; }));

        //xAxisG.call(xAxis);
        xAxisG.call(xAxis)
          .select('.domain')
          .attr('transform', 'translate(0,-'+innerHeight/2+')');
        yAxisG.call(yAxis);
        xAxisLabel.text(xAxisLabelText);
        yAxisLabel.text(yAxisLabelText);

        var circles = g.selectAll("circle").data(data);
        circles.enter().append("circle");
        circles
          .attr("cx",      function (d){ return       xScale(d[xColumn]);     })
          .attr("cy",      function (d){ return       yScale(0);     })
          .attr("r",       function (d){ return       rScale(d[rColumn]);     })
          .attr("fill",    function (d){ return   colorScale(d[colorColumn]); })
          .attr("opacity",    .25)
          .transition().duration(2000)
          .attr("cy",      function (d){ return       yScale(d[yColumn]);     });

        circles.exit().remove();
      }

      function renderLegend(data){
        colorScale.domain(data.map(function (d){
          return d[colorColumn];
        }));

        colorLegendG.call(colorLegend);
        introText.text("");

        listenForHover(colorLegendG.selectAll("rect"), data);
        listenForHover(colorLegendG.selectAll("text"), data);
      }

      function listenForHover(selection){
        selection
          .on("mouseover", function (d){
            hoveredColorValue = d;
            toprightText.text(d);
            var filterData = dataArray.filter(function(d2){return d2[colorColumn] === d })
            renderCircles(filterData);
          })
          .on("mouseout", function (d){
            hoveredColorValue = null;
            //renderCircles(dataArray);
          })
          .style("cursor", "pointer");
      }

      function type(d){
        d.date = new Date(d.date);
        d.score = +d.score;
        return d;
      }

      function myRender(data){
        dataArray = data;
        //renderCircles(dataArray);
        setTimeout(function(){
          renderLegend(dataArray);
          var filterData = dataArray.filter(function(d2){return d2[colorColumn] === "AM1" })
          renderCircles(filterData);
        }, 1000);
      }

      d3.csv("cr_stores_sp.csv", type, myRender);

    </script>
  </body>
</html>
